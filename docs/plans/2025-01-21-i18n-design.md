# I18n Internationalization Design

**Date**: 2025-01-21
**Author**: Claude
**Status**: Design

## Overview

Add comprehensive i18n (internationalization) support to Agent Cowork, enabling the application to support multiple languages starting with Chinese (Simplified) and English.

## Requirements

- Support Chinese (Simplified) and English
- Auto-detect system language on macOS, Windows, and Linux
- Translate both React UI and Electron main process
- Use react-i18next library

## Architecture

### Tech Stack

- **UI Layer**: react-i18next + i18next
- **Electron Main Process**: i18next (core only)
- **Language Detection**: Electron's `app.getLocale()` API

### Architecture Diagram

```
┌─────────────────────────────────────────────────────┐
│                    React UI Layer                    │
│  ┌─────────────────────────────────────────────┐   │
│  │   react-i18next + useTranslation Hook       │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                         ↕ (IPC shared config)
┌─────────────────────────────────────────────────────┐
│              Electron Main Process                   │
│  ┌─────────────────────────────────────────────┐   │
│  │   i18next instance                          │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────┐
│              Translation Resources                   │
│  /locales/{lang}/                                   │
│    ├── ui.json          (UI translations)            │
│    ├── main.json        (Main process translations)  │
│    ├── common.json      (Shared translations)        │
│    └── index.ts         (Export i18next instances)   │
└─────────────────────────────────────────────────────┘
```

## File Structure

```
agent-cowork/
├── locales/                    # Translation resources
│   ├── zh-CN/                  # Chinese translations
│   │   ├── ui.json
│   │   ├── main.json
│   │   └── common.json
│   ├── en/                    # English translations
│   │   ├── ui.json
│   │   ├── main.json
│   │   └── common.json
│   └── index.ts               # i18next config export
│
├── src/
│   ├── ui/
│   │   ├── i18n.ts            # UI layer i18n config
│   │   ├── App.tsx            # Contains I18nextProvider
│   │   └── components/        # All UI components
│   │
│   └── electron/
│       ├── i18n.ts            # Main process i18n config
│       ├── main.ts            # Initialize i18n
│       ├── ipc-handlers.ts    # IPC translations
│       └── libs/
│           └── runner.ts      # Task execution translations
```

## Translation File Format

### locales/en/ui.json

```json
{
  "sidebar": {
    "newSession": "New Session",
    "settings": "Settings",
    "sessions": "Sessions"
  },
  "promptInput": {
    "placeholder": "Describe your task...",
    "send": "Send"
  },
  "settings": {
    "title": "Settings",
    "language": "Language",
    "theme": "Theme"
  }
}
```

### locales/zh-CN/ui.json

```json
{
  "sidebar": {
    "newSession": "新建会话",
    "settings": "设置",
    "sessions": "会话列表"
  },
  "promptInput": {
    "placeholder": "描述你的任务...",
    "send": "发送"
  },
  "settings": {
    "title": "设置",
    "language": "语言",
    "theme": "主题"
  }
}
```

## Core Implementation

### Main Process Initialization

```typescript
// src/electron/i18n.ts
import i18next from 'i18next';
import resources from '../../locales/index';

export const initI18n = () => {
  const locale = app.getLocale(); // Get system language
  const language = locale.startsWith('zh') ? 'zh-CN' : 'en';

  return i18next.createInstance({
    lng: language,
    fallbackLng: 'en',
    resources,
    ns: ['ui', 'main', 'common'],
    defaultNS: 'main',
    saveMissing: true,
    missingKeyHandler: (lng, ns, key) => {
      console.warn(`[i18n] Missing translation: ${lng}.${ns}.${key}`);
    }
  });
};
```

### UI Layer Initialization

```typescript
// src/ui/i18n.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import resources from '../../locales/index';

i18n
  .use(initReactI18next)
  .init({
    lng: window.electronAPI.getLanguage(),
    fallbackLng: 'en',
    resources,
    ns: ['ui', 'main', 'common'],
    defaultNS: 'ui'
  });

export default i18n;
```

### Component Usage

```typescript
// src/ui/components/Sidebar.tsx
import { useTranslation } from 'react-i18next';

export function Sidebar() {
  const { t } = useTranslation();
  return (
    <button>{t('sidebar.newSession')}</button>
  );
}
```

## Error Handling

### Translation Key Fallback Strategy

```
User system language → zh-CN (Chinese)
         ↓ (translation missing)
    fallback → en (English)
         ↓ (still missing)
    return → key name itself (e.g., "sidebar.newSession")
```

### Interpolation and Plurals

```json
{
  "sessionCount": "Created {{count}} session",
  "sessionCount_plural": "Created {{count}} sessions"
}
```

```typescript
t('sessionCount', { count: 5 }); // "Created 5 sessions"
```

## Cross-Platform Language Detection

Electron's `app.getLocale()` works consistently across platforms:

```typescript
const locale = app.getLocale();
// macOS: 'zh-CN', 'en-US'
// Windows: 'zh-CN', 'en-US'
// Linux: 'zh_CN', 'en_US'

const language = locale.startsWith('zh') ? 'zh-CN' : 'en';
```

## Implementation Phases

### Phase 1: Infrastructure (1-2 days)
- Install dependencies: `bun add i18next react-i18next`
- Create `locales/` directory structure
- Configure i18n instances for main process and UI
- Initialize in `main.ts` and `App.tsx`

### Phase 2: UI Component Translation (2-3 days)
- Catalog all hardcoded text in components
- Create `ui.json` translation key structure
- Replace text with `t()` function calls in each component
- Add Chinese and English translations

### Phase 3: Main Process Translation (1-2 days)
- Catalog user-visible text in `ipc-handlers.ts`, `runner.ts`
- Create `main.json` translation keys
- Replace with `i18n.t()` calls

### Phase 4: Testing and Refinement (1 day)
- Test language switching by changing system language
- Check all pages for translation completeness
- Fix missing translation keys

## Testing Strategy

| Test Item | Method |
|-----------|--------|
| Chinese display | Set system language to Simplified Chinese, launch app |
| English display | Set system language to English, launch app |
| Translation completeness | Navigate all pages, check for untranslated English |
| Missing key fallback | Intentionally remove a translation key, verify fallback |
| Cross-platform | Test on macOS, Windows, and Linux |

## Dependencies to Add

```json
{
  "dependencies": {
    "i18next": "^24.x",
    "react-i18next": "^15.x"
  }
}
```

## Files to Modify

### New Files
- `locales/index.ts`
- `locales/zh-CN/ui.json`
- `locales/zh-CN/main.json`
- `locales/zh-CN/common.json`
- `locales/en/ui.json`
- `locales/en/main.json`
- `locales/en/common.json`
- `src/electron/i18n.ts`
- `src/ui/i18n.ts`

### Modified Files
- `src/electron/main.ts` - Initialize i18n
- `src/electron/ipc-handlers.ts` - Add getLanguage handler
- `src/electron/preload.cts` - Expose getLanguage API
- `src/ui/App.tsx` - Wrap with I18nextProvider
- All component files in `src/ui/components/`
